{"version":3,"file":"LazyWagmiConnector.js","sourceRoot":"","sources":["../../../src/lib/wagmi/LazyWagmiConnector.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,QAAQ,EAAE,MAAM,mBAAmB,CAAC;AAE7C,OAAO,EAAE,eAAe,EAA0B,MAAM,OAAO,CAAC;AAEhE,OAAO,EACL,iBAAiB,GAElB,MAAM,sBAAsB,CAAC;AAC9B,OAAO,EAAE,MAAM,EAAE,MAAM,cAAc,CAAC;AAEtC,4GAA4G;AAC5G,MAAM,UAAU,GACd,wxCAAwxC,CAAC;AAe3xC,MAAM,aAAa,GAA8B;IAC/C,KAAK,EAAE,KAAK;CACb,CAAC;AAEF;;GAEG;AACH,MAAM,UAAU,kBAAkB;AAChC,6DAA6D;AAC7D,OAAwB;IAExB,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,wCAAwC,CAAC,CAAC;IAElE,4EAA4E;IAC5E,gGAAgG;IAChG,2DAA2D;IAC3D,MAAM,QAAQ,GAAG,iBAAiB,CAAC;IAEnC,kEAAkE;IAClE,uEAAuE;IACvE,MAAM,WAAW,GAAG,QAAQ,CAAC;QAC3B,cAAc,EAAE,IAAI;QACpB,MAAM,EAAE;YACN,EAAE,EAAE,OAAO;YACX,IAAI,EAAE,cAAc;YACpB,IAAI,EAAE,UAAU;YAChB,QAAQ;SACT;KACF,CAAqC,CAAC;IAEvC,gGAAgG;IAChG,OAAO,eAAe,CACpB,CAAC,qBAAuD,EAAE,EAAE;QAC1D,MAAM,SAAS,GAAG,WAAW,CAAC,qBAAqB,CAAC,CAAC;QACrD,SAAS,CAAC,WAAW,GAAG,KAAK,EAAE,WAAkC,EAAE,EAAE;YACnE,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,sCAAsC,CAAC,CAAC;YAChE,QAAQ,CAAC,iBAAiB,CAAC,WAAW,CAAC,CAAC;YAExC,+DAA+D;YAC/D,MAAM,QAAQ,GAAG,MAAM,WAAW,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,cAAc,EAAE,CAAC,CAAC;YACvE,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CACrB,+CAA+C,EAC/C,QAAQ,CACT,CAAC;YACF,qBAAqB,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,EAAE;gBAC3C,QAAQ;aACT,CAAC,CAAC;YAEH,4EAA4E;YAC5E,2EAA2E;YAC3E,kEAAkE;YAClE,wEAAwE;YACxE,8DAA8D;YAC9D,wCAAwC;YACxC,QAAQ,CAAC,EAAE,CAAC,YAAY,EAAE,GAAG,EAAE;gBAC7B,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CACrB,yEAAyE,CAC1E,CAAC;gBACF,QAAQ,CAAC,mBAAmB,EAAE,CAAC;YACjC,CAAC,CAAC,CAAC;QACL,CAAC,CAAC;QAEF,SAAS,CAAC,KAAK,GAAG,GAAG,EAAE,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;QAEzC,OAAO,SAAS,CAAC;IACnB,CAAC,CACF,CAAC;AACJ,CAAC;AAED,kBAAkB,CAAC,IAAI,GAAG,OAAgB,CAAC;AAE3C,MAAM,CAAC,MAAM,cAAc,GAAG,CAAC,SAA0B,EAAE,EAAE,EAAE,CAC7D,kBAAkB,CAAC;IACjB,GAAG,aAAa;IAChB,GAAG,MAAM;CACV,CAAC,CAAC","sourcesContent":["import { injected } from \"@wagmi/connectors\";\nimport type { GenericEthereumProvider } from \"../../types.js\";\nimport { createConnector, type CreateConnectorFn } from \"wagmi\";\nimport type { EIP1193Provider } from \"viem\";\nimport {\n  singletonProvider,\n  type TypedEthereumProvider,\n} from \"../ethereum/index.js\";\nimport { logger } from \"../logger.js\";\n\n// This is: https://cdn.prod.website-files.com/6721152f5cf7d1402980ed13/672504c1535365ebb956eeda_Favicon.png\nconst walletLogo =\n  \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAANVSURBVHgBtVc7S+xAFJ4V+xvtLISUFhbxH6yFtqaws9gFbWW3EC2T29ldVzub3UYblbsXRFER94KiiI+riAoiibiw1T7uL4jni5kw2VcmYfeDYSaTmXPOzDkz55sEC4HjOApVqZOTk+Tr66tWq9XUbuOHh4ftkZERe3Z2tkiffxKJhM3igBRrT09PZ5lMxlEUxUFXlII56XTagQySpXbSk2jX+f7+ntnY2FgjBPpJKFNV1a3bodFoMNu23VoEGcJSqZQ5OTn5k4Xh9vY2T0oCK1leXq4/Pj7+ppVkqKSpJDsUHWMwdnNzsy7KQZtceO+5VE45FNNumF0ndQDmUMlChmgEXNJ2wsfHh8GVY9UHBwdWN99FMES9urqyeBxBR7lc/tUyKJvN+ivvlXJBvnJxcXHP5SM44TJ/wM3NTYH/NAzD6aVywQh1dXXVd8fOzs6Z/4Mi1N8egsn6BMjmbtZ1/XsXECi8k45dX1YvGKDwXUBMWJZlMm8rXAOOjo6KEYQlPz8/11AC/gwBxjPRDevr6xa3CLshI4TGGQgkJgQVnXHZufrW1pYFvbgXmGmarhBN02DAjIQAJZ/Pt1y9kBPnvhjgDe96/S8xRy0WWz1VKpVQaSwiBlh02BMTEy2dyBH4xyIisgGUXhvz8/M5T6GvfGFhIRcn9Q6yGBgdHc3C30NDQylkvv39/b/j4+NSQdiMOC5wQQTlB0+7Ly8vDouJ2Abc3d0leZsyphbnBAQMAJEgqDKTwJYuLy99hZTt0I58AoBBcDgo9rZTdhXaw8OD/yEcwVLYRBCa7e1to1qtsunp6cbg2NjYP24AMZkktddYOBp7e3sFFgNEepJzc3Mq2nQVl9xkxMnCyspKPa4vZcGvfhQ3L0AhJyN+huoTsP0883qk5Dtunp+f/Yzo7YLKegzIXFxc9Fcf4IawRKRkh4eHPadk4IUsSMmCp+bt7S0rktJeGQEZ5+fn9yIpPT09NdsOvr6+Loi03EuxRhxDPFpuNNNylwN0Q7MRaIOqHR8f84eJHvYwwfsCipvlINaaT1nbpxlOQi6XM3r1NKP3JVtaWsohiTFZYNtB18GYxZXIFvgcD1vwvm6cMSFjCFUzu7u7eqVSUWWe57hdp6amcFcXwjjCFylL3JauTfcHAAAAAElFTkSuQmCC\";\n\nexport type CreateLazyConnectorProperties = {\n  provider: TypedEthereumProvider | null;\n  setProvider: (newProvider: TypedEthereumProvider) => Promise<void>;\n  ready: () => boolean;\n};\nexport type CreateLazyConnectorFn = CreateConnectorFn<\n  GenericEthereumProvider,\n  CreateLazyConnectorProperties\n> & { provider: EIP1193Provider | null };\n\ntype ConnectorConfig = {\n  debug?: boolean;\n};\nconst defaultConfig: Required<ConnectorConfig> = {\n  debug: false,\n};\n\n/**\n * Wagmi connector implementation, that takes a lazy EIP1193 provider, that can be instantiated later, and turns it into a wagmi connector\n */\nexport function LazyWagmiConnector(\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  _config: ConnectorConfig,\n): CreateConnectorFn {\n  logger.web3.wagmi.debug(\"LazyWagmiConnector: Creating connector\");\n\n  // use a lazy ethereum 1193 provider that will be passed into the connector.\n  // this provider will be populated later once the user has logged in, via the setProvider method\n  // that is added to the standard wagmi connector interface.\n  const provider = singletonProvider;\n\n  // create a wagmi connector function that wraps the 1193 provider,\n  // providing metadata, and linking wagmi functions to eip1193 functions\n  const connectorFn = injected({\n    shimDisconnect: true,\n    target: {\n      id: \"civic\",\n      name: \"Civic Wallet\",\n      icon: walletLogo,\n      provider,\n    },\n  }) as unknown as CreateLazyConnectorFn;\n\n  // augment the connector function with custom functions to allow injection of the provider later\n  return createConnector(\n    (createConnectorConfig: Parameters<CreateConnectorFn>[0]) => {\n      const connector = connectorFn(createConnectorConfig);\n      connector.setProvider = async (newProvider: TypedEthereumProvider) => {\n        logger.web3.wagmi.debug(\"LazyWagmiConnector: Setting provider\");\n        provider.setImplementation(newProvider);\n\n        // notify anything listening that it should update its accounts\n        const accounts = await newProvider.request({ method: \"eth_accounts\" });\n        logger.web3.wagmi.debug(\n          \"LazyWagmiConnector: Setting provider accounts\",\n          accounts,\n        );\n        createConnectorConfig.emitter.emit(\"change\", {\n          accounts,\n        });\n\n        // Wagmi events may continue to query the provider after it has disconnected\n        // Since the user has just logged out, but the provider may still be active\n        // this fools wagmi into thinking that the wallet is still active.\n        // Therefore, removing the underlying provider from the proxy simulates,\n        // in a not particularly elegant way, the wallet being closed.\n        // There may be a better way to do this.\n        provider.on(\"disconnect\", () => {\n          logger.web3.wagmi.debug(\n            \"LazyWagmiConnector: Provider disconnected - clearing the implementation\",\n          );\n          provider.clearImplementation();\n        });\n      };\n\n      connector.ready = () => provider.ready();\n\n      return connector;\n    },\n  );\n}\n\nLazyWagmiConnector.type = \"civic\" as const;\n\nexport const embeddedWallet = (config: ConnectorConfig = {}) =>\n  LazyWagmiConnector({\n    ...defaultConfig,\n    ...config,\n  });\n"]}