import { injected } from "@wagmi/connectors";
import { createConnector } from "wagmi";
import { singletonProvider, } from "../ethereum/index.js";
import { logger } from "../logger.js";
// This is: https://cdn.prod.website-files.com/6721152f5cf7d1402980ed13/672504c1535365ebb956eeda_Favicon.png
const walletLogo = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAANVSURBVHgBtVc7S+xAFJ4V+xvtLISUFhbxH6yFtqaws9gFbWW3EC2T29ldVzub3UYblbsXRFER94KiiI+riAoiibiw1T7uL4jni5kw2VcmYfeDYSaTmXPOzDkz55sEC4HjOApVqZOTk+Tr66tWq9XUbuOHh4ftkZERe3Z2tkiffxKJhM3igBRrT09PZ5lMxlEUxUFXlII56XTagQySpXbSk2jX+f7+ntnY2FgjBPpJKFNV1a3bodFoMNu23VoEGcJSqZQ5OTn5k4Xh9vY2T0oCK1leXq4/Pj7+ppVkqKSpJDsUHWMwdnNzsy7KQZtceO+5VE45FNNumF0ndQDmUMlChmgEXNJ2wsfHh8GVY9UHBwdWN99FMES9urqyeBxBR7lc/tUyKJvN+ivvlXJBvnJxcXHP5SM44TJ/wM3NTYH/NAzD6aVywQh1dXXVd8fOzs6Z/4Mi1N8egsn6BMjmbtZ1/XsXECi8k45dX1YvGKDwXUBMWJZlMm8rXAOOjo6KEYQlPz8/11AC/gwBxjPRDevr6xa3CLshI4TGGQgkJgQVnXHZufrW1pYFvbgXmGmarhBN02DAjIQAJZ/Pt1y9kBPnvhjgDe96/S8xRy0WWz1VKpVQaSwiBlh02BMTEy2dyBH4xyIisgGUXhvz8/M5T6GvfGFhIRcn9Q6yGBgdHc3C30NDQylkvv39/b/j4+NSQdiMOC5wQQTlB0+7Ly8vDouJ2Abc3d0leZsyphbnBAQMAJEgqDKTwJYuLy99hZTt0I58AoBBcDgo9rZTdhXaw8OD/yEcwVLYRBCa7e1to1qtsunp6cbg2NjYP24AMZkktddYOBp7e3sFFgNEepJzc3Mq2nQVl9xkxMnCyspKPa4vZcGvfhQ3L0AhJyN+huoTsP0883qk5Dtunp+f/Yzo7YLKegzIXFxc9Fcf4IawRKRkh4eHPadk4IUsSMmCp+bt7S0rktJeGQEZ5+fn9yIpPT09NdsOvr6+Loi03EuxRhxDPFpuNNNylwN0Q7MRaIOqHR8f84eJHvYwwfsCipvlINaaT1nbpxlOQi6XM3r1NKP3JVtaWsohiTFZYNtB18GYxZXIFvgcD1vwvm6cMSFjCFUzu7u7eqVSUWWe57hdp6amcFcXwjjCFylL3JauTfcHAAAAAElFTkSuQmCC";
const defaultConfig = {
    debug: false,
};
/**
 * Wagmi connector implementation, that takes a lazy EIP1193 provider, that can be instantiated later, and turns it into a wagmi connector
 */
export function LazyWagmiConnector(
// eslint-disable-next-line @typescript-eslint/no-unused-vars
_config) {
    logger.web3.wagmi.debug("LazyWagmiConnector: Creating connector");
    // use a lazy ethereum 1193 provider that will be passed into the connector.
    // this provider will be populated later once the user has logged in, via the setProvider method
    // that is added to the standard wagmi connector interface.
    const provider = singletonProvider;
    // create a wagmi connector function that wraps the 1193 provider,
    // providing metadata, and linking wagmi functions to eip1193 functions
    const connectorFn = injected({
        shimDisconnect: true,
        target: {
            id: "civic",
            name: "Civic Wallet",
            icon: walletLogo,
            provider,
        },
    });
    // augment the connector function with custom functions to allow injection of the provider later
    return createConnector((createConnectorConfig) => {
        const connector = connectorFn(createConnectorConfig);
        connector.setProvider = async (newProvider) => {
            logger.web3.wagmi.debug("LazyWagmiConnector: Setting provider");
            provider.setImplementation(newProvider);
            // notify anything listening that it should update its accounts
            const accounts = await newProvider.request({ method: "eth_accounts" });
            logger.web3.wagmi.debug("LazyWagmiConnector: Setting provider accounts", accounts);
            createConnectorConfig.emitter.emit("change", {
                accounts,
            });
            // Wagmi events may continue to query the provider after it has disconnected
            // Since the user has just logged out, but the provider may still be active
            // this fools wagmi into thinking that the wallet is still active.
            // Therefore, removing the underlying provider from the proxy simulates,
            // in a not particularly elegant way, the wallet being closed.
            // There may be a better way to do this.
            provider.on("disconnect", () => {
                logger.web3.wagmi.debug("LazyWagmiConnector: Provider disconnected - clearing the implementation");
                provider.clearImplementation();
            });
        };
        connector.ready = () => provider.ready();
        return connector;
    });
}
LazyWagmiConnector.type = "civic";
export const embeddedWallet = (config = {}) => LazyWagmiConnector({
    ...defaultConfig,
    ...config,
});
//# sourceMappingURL=LazyWagmiConnector.js.map